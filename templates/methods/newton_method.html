{% extends 'base.html' %}

{% block content %}

<!-- TODO: Implementar input de la funcion -->

<div id="container-fluid text-center">
    <div class="row align-items-center" style="height: 100vh;">
        <div class="col-3 ms-5">
            <div class="card-container">
                <div class="card p-4">
                    <h1>Newton Method</h1>

                    <!-- TODO: Este formulario deberia actuar como componente -->
                    <h6>Function</h6>
                    <math-field id="function" style="min-width: 200px;">e^{-x}+\sin x</math-field>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="toggle-mathfield" value="off">
                        <label class="form-check-label" for="toggle-mathfield">derivada manual</label>
                    </div>

                    <h6 id="derivateFieldLabel" style="display: none;">Derivate</h6>
                    <math-field class="mb-2" id="derivateField" style="min-width: 200px; display: none;"></math-field>

                    <div class="input-group mb-3">
                        <button class="btn btn-outline-secondary" type="button" id="previewButton">Ver</button>
                        <input type="text" class="form-control" placeholder="x0" id="x0">
                    </div>

                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Iteraciones maximas</span>
                        <input type="text" class="form-control" placeholder="10000" aria-describedby="basic-addon1"
                            id="nmax">
                    </div>

                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Tolerancia</span>
                        <input type="text" class="form-control" placeholder="0.0000001" aria-describedby="basic-addon1"
                            id="tol">
                    </div>

                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Last N-rows</span>
                        <input type="text" class="form-control" placeholder="30" aria-describedby="basic-addon1"
                            id="nrows">
                    </div>

                    <button id="calculation-btn">Graficar funcion</button>



                </div>
            </div>
        </div>

        <div class="col-5">
            <div class="card" id="graph-container" style="height: 100vh; width: 100%;">
                <div id="graph" style="height: 97%; width: 100%;"></div>
            </div>
        </div>

        <div class="col-4">
            <div class="card p-3">
                <h4>Resultados</h4>
                <div class="table-responsive">
                    <table id="result-table" class="table table-striped table-bordered table-hover table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>Iteración</th>
                                <th>x</th>
                                <th>Error Abs</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Aquí JS meterá las filas -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>

        //Referencias
        const mathField = document.getElementById('function');
        const derivateMathField = document.getElementById('function');
        const toggle = document.getElementById('toggle-mathfield');
        const derivateField = document.getElementById('derivateField');
        const derivateFieldLabel = document.getElementById('derivateFieldLabel');
        const x0input = document.getElementById("x0")
        const nmax = document.getElementById("nmax")
        const tol = document.getElementById("tol")
        const nrows = document.getElementById("nrows")


        //Variables
        const ce = new ComputeEngine.ComputeEngine();


        //Funciones
        //Esta funcion se encarga de camibiar el formato String a ECMAScript 
        function toECMAScript(expr) {
            return expr
                .replace(/e\^\(([^)]+)\)/g, "exp($1)")
                .replace(/e\^([a-zA-Z0-9]+)/g, "exp($1)")
                .replace(/\bpi\b/gi, "PI");
        }

        const graficar = (data, raiz = NaN) => {

            functionPlot({
                target: "#graph",
                grid: true,
                width: document.getElementById('graph').offsetWidth,
                height: document.getElementById('graph').offsetHeight,
                data
            });
        }

        defaultData = [
            {
                fn: "exp(-x)+sin(x)"
            },
            {
                fn: "-exp(-x)+cos(x)"
            }
        ]


        graficar(defaultData)

        //Logica para ocultar el math field de la derivada
        toggle.addEventListener('change', function () {
            derivateField.style.display = this.checked ? 'block' : 'none';
            derivateFieldLabel.style.display = this.checked ? 'block' : 'none';
        });


        //Logica de la previsualizacion
        document.getElementById("previewButton").addEventListener("click", (event) => {

            const ceExpression = ce.parse(mathField.value, { canonical: false }).toString();
            let tangent_str


            if (!toggle.checked) {

                fetch('/calculations/derivate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ function: mathField.value })
                })
                    .then(response => response.json())
                    .then(data => {
                        const df = ce.parse(data.resultado)

                        const f = ce.parse(mathField.value)

                        const n = parseFloat(document.getElementById("x0").value);

                        const y0 = f.subs({ x: n }).toString();
                        const m = df.subs({ x: n }).toString();

                        tangent_str = `(${m})*(x - ${n}) + (${y0})`;
                        tangent_str = toECMAScript(tangent_str)

                        graphData = [
                            {
                                fn: toECMAScript(ceExpression)
                            },
                            {
                                fn: tangent_str
                            }
                        ]

                        graficar(graphData)

                    })
            } else {
                const ceDerivateExpression = ce.parse(derivateField.value, { canonical: false }).toString();
                tangent_str = toECMAScript(ceDerivateExpression)
            }

        })

        document.getElementById("calculation-btn").addEventListener("click", (event) => {

            const ceExpression = ce.parse(mathField.value, { canonical: false }).toString();
            const ceDerivateExpression = ce.parse(derivateField.value, { canonical: false }).toString();

            //TODO: Mandar la funcion al backend para obtener los resutados del metodo y recibirrlos
            fetch('/eval/newton_method', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    function: mathField.value,
                    x0: parseFloat(x0input.value),
                    Nmax: parseInt(nmax.value),
                    tol: parseFloat(tol.value),
                    nrows: parseInt(nrows.value)
                })
            })
                .then(response => response.json())
                .then((data) => {

                    console.log(data);

                    const tbody = document.querySelector("#result-table tbody");
                    tbody.innerHTML = ""; // limpiar por si acaso

                    for (let i = 0; i < data.historial.iteraciones.length; i++) {
                        const row = `
                            <tr>
                                <td>${data.historial.iteraciones[i]}</td>
                                <td>${data.historial.x[i].toFixed(6)}</td>
                                <td>${data.historial.errorAbs[i].toExponential(3)}</td>
                            </tr>
                        `;
                        tbody.insertAdjacentHTML("beforeend", row);
                    }

                    lastX = data.historial.x[data.historial.x.length - 1]

                    graphData = [
                        {
                            fn: toECMAScript(ceExpression)
                        },
                        {
                            points: [
                                [lastX, -1000],
                                [lastX, 1000]
                            ],
                            fnType: "points",
                            graphType: "polyline",
                            color: "red"
                        }
                    ]
                    graficar(graphData)
                })


            // Graficar la función

        })
    </script>


</div>

{% endblock %}