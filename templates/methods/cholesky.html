{% extends 'base.html' %}
{% block content %}

<div class="container-fluid text-center">
  <div class="row justify-content-center my-4">
    <div class="col-11 col-md-10 col-lg-9">

      <!-- Title -->
      <div class="card mb-3">
        <div class="card-body">
          <h3 class="m-0">Cholesky Decomposition</h3>
          <small class="text-muted">A must be symmetric positive definite (SPD).</small>
        </div>
      </div>

      <div class="row g-3">
        <!-- Input card -->
        <div class="col-lg-5">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="mb-3">Input</h5>

              <!-- Size -->
              <div class="row g-2 text-start mb-3">
                <div class="col-12">
                  <label class="form-label mb-1">Size (n × n)</label>
                  <input id="sizeN" type="number" class="form-control" min="1" max="12" value="3">
                </div>
              </div>

              <!-- Matrix A -->
              <div class="matrix-input-wrapper">
                <label class="form-label matrix-label">Matrix A (n × n)</label>
                <div id="matrixAContainer" class="matrix-grid matrix-input"></div>
              </div>

              <!-- Vector b -->
              <div class="matrix-input-wrapper mt-3">
                <label class="form-label matrix-label">Vector b (n)</label>
                <div id="vectorBContainer" class="matrix-grid matrix-input"></div>
              </div>

              <div class="d-grid gap-2 mt-3">
                <button id="run" class="btn btn-calc-gauss">Compute</button>
                <button id="example" class="btn btn-fill-example">Fill SPD example</button>
                <button id="clear" class="btn btn-outline-danger">Clear</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Result card -->
        <div class="col-lg-7">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="mb-3">Result</h5>
              <div id="alert" class="alert alert-danger d-none"></div>
              <div id="loading" class="d-none text-muted mb-2">Computing…</div>

              <div id="solucion"></div>
              <div id="otros"></div>
              <div id="matrices"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<link rel="stylesheet" href="/static/css/matrix_grid.css">

<style>
  .matrix-label{
    display:block;
    margin-bottom:4px;
    font-weight:600;
  }

  .matrix-input-wrapper{
    text-align:center;
  }
  .matrix-input-wrapper .matrix-label{
    text-align:left;
    margin-left:4px;
  }

  /* bigger input cells for matrix and vector */
  .matrix-grid table{
    border-collapse:separate;
    border-spacing:6px;
    margin:0 auto;
  }
  .matrix-grid td{
    min-width:60px;
    height:40px;
  }
  .matrix-grid input{
    width:100%;
    text-align:center;
    padding:4px 6px;
    font-size:0.95rem;
  }

  /* Gaussian-style compute button */
  .btn-calc-gauss{
    background-color:#004000;
    border:1px solid #00ff4d;
    color:#ffffff;
    font-weight:600;
    border-radius:3px;
    height:40px;
    box-shadow:
      0 0 3px #00ff4d,
      0 0 8px #00ff4d,
      0 0 16px rgba(0,255,77,0.9);
  }
  .btn-calc-gauss:hover{
    background-color:#005200;
    box-shadow:
      0 0 5px #00ff4d,
      0 0 12px #00ff4d,
      0 0 20px rgba(0,255,77,1);
  }

  /* light green example button */
  .btn-fill-example{
    background-color:#b8ffd0;
    border:1px solid #46e67f;
    color:#064b1c;
    border-radius:3px;
    font-weight:500;
    height:38px;
    box-shadow:0 0 6px rgba(0,255,136,0.7);
  }
  .btn-fill-example:hover{
    background-color:#a3ffbf;
    box-shadow:0 0 10px rgba(0,255,136,0.9);
  }

  /* LU-style result cards */
  .lu-result-card{
    border: 1px solid #dee2e6;
    box-shadow: 0 1px 2px rgba(0,0,0,.05);
  }
  .lu-result-card .card-header{
    background:#f8f9fa;
    font-size:0.9rem;
  }
  .lu-grid{
    display:inline-block;
    padding:6px 10px;
    border-radius:10px;
    background:#ffffff;
  }
  .lu-grid table{
    border-collapse:separate;
    border-spacing:6px;
  }
  .lu-grid td{
    min-width:90px;
    height:40px;
    padding:4px 10px;
    border-radius:6px;
    border:1px solid #ced4da;
    text-align:center;
    font-family:monospace;
    font-size:0.95rem;
  }
</style>

<script>
/* ===== helpers ===== */
function fmt(v){
  // Keep complex strings like "1.937106i" as they are
  if (typeof v === 'string') {
    if (v.includes('i')) return v;
    const num = Number(v);
    if (!Number.isNaN(num)) v = num;
    else return v;
  }
  if (typeof v === 'number' && isFinite(v)) {
    return Number(v.toFixed(6));
  }
  return v;
}

/* solo el grid con estilo LU */
function renderGrid(matrix){
  if (!matrix) return '';
  const isVector = Array.isArray(matrix) && matrix.length && !Array.isArray(matrix[0]);

  let rowsHTML = '';
  if (isVector){
    rowsHTML = '<tr>' + matrix.map(v => `<td>${fmt(v)}</td>`).join('') + '</tr>';
  } else {
    rowsHTML = matrix
      .map(row => '<tr>' + row.map(v => `<td>${fmt(v)}</td>`).join('') + '</tr>')
      .join('');
  }

  return `
    <div class="lu-grid">
      <table>
        <tbody>
          ${rowsHTML}
        </tbody>
      </table>
    </div>
  `;
}

/* card de resultado estilo LU */
function renderTable(title, matrix){
  if (!matrix) return '';
  return `
    <div class="card lu-result-card mb-3 text-start">
      <div class="card-header py-2 text-center">
        <strong>${title}</strong>
      </div>
      <div class="card-body text-center">
        ${renderGrid(matrix)}
      </div>
    </div>
  `;
}

function show(el, on=true){ el.classList[on?'remove':'add']('d-none'); }
function setHTML(el, html){ el.innerHTML = html; }

/* ===== build inputs ===== */
function buildMatrixInputs(n){
  const table = document.createElement('table');
  table.className = 'table table-sm table-bordered align-middle m-0';
  const tbody = document.createElement('tbody');
  for(let i=0;i<n;i++){
    const tr = document.createElement('tr');
    for(let j=0;j<n;j++){
      const td = document.createElement('td');
      const inp = document.createElement('input');
      inp.type = 'number'; inp.step = 'any';
      inp.className = 'form-control form-control-sm';
      inp.value = (i === j) ? '4' : '1';
      td.appendChild(inp); tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  return table;
}

function buildVectorInputs(n, def=0){
  const table = document.createElement('table');
  table.className = 'table table-sm table-bordered align-middle m-0';
  const tbody = document.createElement('tbody');
  for(let i=0;i<n;i++){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    const inp = document.createElement('input');
    inp.type = 'number'; inp.step = 'any';
    inp.className = 'form-control form-control-sm';
    inp.value = String(def);
    td.appendChild(inp); tr.appendChild(td);
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  return table;
}

function readMatrix(container){
  const rows = [];
  container.querySelectorAll('tr').forEach(tr=>{
    const row = [];
    tr.querySelectorAll('input').forEach(inp=> row.push(parseFloat(inp.value || '0')));
    rows.push(row);
  });
  return rows;
}

function readVector(container){
  const v = [];
  container.querySelectorAll('input').forEach(inp=> v.push(parseFloat(inp.value || '0')));
  return v;
}

/* ===== DOM refs ===== */
const sizeN = document.getElementById('sizeN');
const matrixAContainer = document.getElementById('matrixAContainer');
const vectorBContainer = document.getElementById('vectorBContainer');

const runBtn = document.getElementById('run');
const clearBtn = document.getElementById('clear');
const exampleBtn = document.getElementById('example');

const alertBox = document.getElementById('alert');
const loading = document.getElementById('loading');
const solucion = document.getElementById('solucion');
const matrices = document.getElementById('matrices');
const otros = document.getElementById('otros');

/* ===== initial state ===== */
function rebuild(){
  const n = Math.max(1, Math.min(12, parseInt(sizeN.value || '1', 10)));
  sizeN.value = n;
  matrixAContainer.innerHTML = '';
  vectorBContainer.innerHTML = '';
  matrixAContainer.appendChild(buildMatrixInputs(n));
  vectorBContainer.appendChild(buildVectorInputs(n, 0));
}
sizeN.addEventListener('change', rebuild);

/* SPD example (the one you showed) */
exampleBtn.addEventListener('click', ()=>{
  const A = [
    [4, -1, 0, 3],
    [1, 15.5, 3, 8],
    [0, -1.3, -4, 1.1],
    [14, 5, -2, 30]
  ];
  const b = [1, 1, 1, 1];

  sizeN.value = A.length; rebuild();
  matrixAContainer.querySelectorAll('tr').forEach((tr,i)=>{
    tr.querySelectorAll('input').forEach((inp,j)=> inp.value = A[i][j]);
  });
  vectorBContainer.querySelectorAll('input').forEach((inp,i)=> inp.value = b[i]);
});

/* clear all */
clearBtn.addEventListener('click', ()=>{
  matrixAContainer.querySelectorAll('input').forEach(inp=> inp.value = '0');
  vectorBContainer.querySelectorAll('input').forEach(inp=> inp.value = '0');
  setHTML(solucion,''); setHTML(matrices,''); setHTML(otros,'');
  show(alertBox, false);
});

/* ===== compute ===== */
runBtn.addEventListener('click', async ()=>{
  setHTML(solucion,''); setHTML(matrices,''); setHTML(otros,'');
  show(alertBox, false); show(loading, true);

  try{
    const A = readMatrix(matrixAContainer);
    const b = readVector(vectorBContainer);

    const res = await fetch('/eval/cholesky', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ A, b })
    });

    const data = await res.json();
    show(loading, false);

    if (!res.ok || data.error){
      // show Python error (SPD fail, shape issues, etc.)
      alertBox.textContent = data.error || 'Computation error';
      show(alertBox, true);
    }

    // ---- solution x ----
    if (data.x) {
      setHTML(solucion, renderTable('Solution x', data.x));
    }

    // ---- intermediate vector y ----
    if (data.y) {
      setHTML(otros, renderTable('Intermediate vector y (Ly = b)', data.y));
    }

    // ---- matrices L and Lt ----
    let mHTML = '';
    if (data.L)  mHTML += renderTable('Matrix L', data.L);
    if (data.Lt) mHTML += renderTable('Matrix Lᵀ', data.Lt);
    setHTML(matrices, mHTML);

    // ---- steps / stages ----
    if (Array.isArray(data.etapas) && data.etapas.length){
      let stepsHTML = '<div class="text-start mt-3"><h6 class="mb-2">Steps</h6>';

      data.etapas.forEach((step, idx) => {
        let title;
        let body = '';

        // Step 0: original matrix A
        if (step.A){
          title = 'Step 0 – original matrix A';
          body += renderGrid(step.A);
        } else {
          const k = step.k ?? (idx);
          title = `Step ${k}`;
          if (step.L){
            body += '<div class="mb-2"><strong>L</strong><br>' + renderGrid(step.L) + '</div>';
          }
          if (step.U){
            body += '<div class="mb-2"><strong>U</strong><br>' + renderGrid(step.U) + '</div>';
          }
        }

        stepsHTML += `
          <div class="card lu-result-card mb-2">
            <div class="card-header py-2 text-center">
              <strong>${title}</strong>
            </div>
            <div class="card-body text-center">
              ${body}
            </div>
          </div>
        `;
      });

      stepsHTML += '</div>';
      matrices.insertAdjacentHTML('beforeend', stepsHTML);
    }

  }catch(err){
    show(loading, false);
    alertBox.textContent = 'Unexpected error: ' + (err && err.message ? err.message : err);
    show(alertBox, true);
  }
});

/* init: n = 3 */
rebuild();
</script>
{% endblock %}
